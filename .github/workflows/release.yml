name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a release even if no version change detected'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.version.outputs.should_release }}
      tag_exists: ${{ steps.version.outputs.tag_exists }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation

      - name: Determine version
        id: version
        env:
          # Force release on push to main, or when manually triggered with force_release
          FORCE_RELEASE: ${{ github.event_name == 'push' || inputs.force_release }}
        run: |
          # First, check if HEAD already has a tag
          EXISTING_TAG=$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

          if [ -n "$EXISTING_TAG" ]; then
            # Use existing tag version
            VERSION="${EXISTING_TAG#v}"
            echo "Found existing tag: $EXISTING_TAG"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "No existing tag on HEAD, calculating version from commits..."
          echo "tag_exists=false" >> $GITHUB_OUTPUT

          # Calculate version using conventional commits
          chmod +x ./scripts/get-version.sh
          VERSION=$(./scripts/get-version.sh)
          echo "Calculated version: $VERSION"

          # Check if this calculated version already exists as a tag (on a different commit)
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists on a different commit"

            if [ "$FORCE_RELEASE" = "true" ]; then
              # Force release: bump patch until we find an unused version
              echo "Force release enabled, finding next available version..."
              IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
              while git rev-parse "v$MAJOR.$MINOR.$PATCH" >/dev/null 2>&1; do
                PATCH=$((PATCH + 1))
              done
              VERSION="$MAJOR.$MINOR.$PATCH"
              echo "Next available version: $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "should_release=true" >> $GITHUB_OUTPUT
            else
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "should_release=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "New version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.should_release == 'true' || inputs.force_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get last tag (excluding current if it exists)
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "Last tag: ${LAST_TAG:-(none)}"

          # Generate changelog from commits
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log "$LAST_TAG..HEAD" --pretty=format:"- %s" --reverse)
            COMPARE_URL="https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${VERSION}"
          else
            COMMITS=$(git log --pretty=format:"- %s" --reverse | head -50)
            COMPARE_URL="https://github.com/${{ github.repository }}/commits/v${VERSION}"
          fi

          # Create changelog content
          cat > changelog.md << EOF
          ## What's Changed

          $COMMITS

          **Full Changelog**: $COMPARE_URL
          EOF

          echo "Generated changelog:"
          cat changelog.md

      - name: Upload changelog
        if: steps.version.outputs.should_release == 'true' || inputs.force_release
        uses: actions/upload-artifact@v6
        with:
          name: changelog
          path: changelog.md

  build-artifacts:
    name: Build (${{ matrix.runtime }})
    needs: calculate-version
    if: needs.calculate-version.outputs.should_release == 'true' || inputs.force_release
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ needs.calculate-version.outputs.version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runtime: win-x64
            os: windows-latest
            artifact_ext: .zip
          - runtime: linux-x64
            os: ubuntu-latest
            artifact_ext: .tar.gz
          - runtime: linux-arm64
            os: ubuntu-latest
            artifact_ext: .tar.gz
          - runtime: osx-x64
            os: macos-latest
            artifact_ext: .tar.gz
          - runtime: osx-arm64
            os: macos-latest
            artifact_ext: .tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y vlc libvlc-dev fonts-dejavu-core

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install --cask vlc

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Restore
        run: dotnet restore src/LCDPossible.sln

      - name: Build
        run: dotnet build src/LCDPossible.sln --configuration Release --no-restore

      - name: Test
        run: |
          # On macOS, skip video tests due to LibVLC native library loading issues
          if [ "$RUNNER_OS" == "macOS" ]; then
            dotnet test src/LCDPossible.sln --configuration Release --no-build --verbosity normal --filter "FullyQualifiedName!~Video&FullyQualifiedName!~WildcardAll"
          else
            dotnet test src/LCDPossible.sln --configuration Release --no-build --verbosity normal
          fi
        shell: bash

      - name: Publish
        shell: bash
        run: |
          dotnet publish src/LCDPossible/LCDPossible.csproj \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --self-contained true \
            -p:Version=${{ env.VERSION }} \
            --output ./publish

      - name: Copy plugins to publish folder
        shell: bash
        run: |
          # Build outputs plugins to .build/LCDPossible/bin/Release/net10.0/plugins/
          # Copy them to the publish folder
          BUILD_PLUGINS=".build/LCDPossible/bin/Release/net10.0/plugins"
          if [ -d "$BUILD_PLUGINS" ]; then
            cp -r "$BUILD_PLUGINS" ./publish/
            echo "Copied plugins from $BUILD_PLUGINS"
            ls -la ./publish/plugins/ || true
          else
            echo "Warning: Plugins folder not found at $BUILD_PLUGINS"
            # Try alternate location
            ALT_PLUGINS="src/LCDPossible/bin/Release/net10.0/plugins"
            if [ -d "$ALT_PLUGINS" ]; then
              cp -r "$ALT_PLUGINS" ./publish/
              echo "Copied plugins from $ALT_PLUGINS"
            fi
          fi

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}.zip

      - name: Create archive (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          tar -czvf ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}.tar.gz -C ./publish .

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: lcdpossible-${{ matrix.runtime }}
          path: ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}${{ matrix.artifact_ext }}

  create-release:
    name: Create Release
    needs: [calculate-version, build-artifacts]
    if: needs.calculate-version.outputs.should_release == 'true' || inputs.force_release
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.calculate-version.outputs.version }}
      TAG_EXISTS: ${{ needs.calculate-version.outputs.tag_exists }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: lcdpossible-*

      - name: Display artifacts
        run: ls -R ./artifacts

      - name: Create tag (if not exists)
        if: env.TAG_EXISTS == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: LCDPossible v${{ env.VERSION }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            ./artifacts/lcdpossible-win-x64/*
            ./artifacts/lcdpossible-linux-x64/*
            ./artifacts/lcdpossible-linux-arm64/*
            ./artifacts/lcdpossible-osx-x64/*
            ./artifacts/lcdpossible-osx-arm64/*
