name: Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a release even without new conventional commits'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.version.outputs.should_release }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation

      - name: Calculate version from conventional commits
        id: version
        run: |
          chmod +x ./scripts/get-version.sh
          VERSION=$(./scripts/get-version.sh)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if this version already exists as a tag
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version: $VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.should_release == 'true' || inputs.force_release
        run: |
          # Get last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Generate changelog from commits
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log "$LAST_TAG..HEAD" --pretty=format:"- %s" --reverse)
          else
            COMMITS=$(git log --pretty=format:"- %s" --reverse | head -50)
          fi

          # Create changelog content
          CHANGELOG="## What's Changed

          $COMMITS

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG:-initial}...v${{ steps.version.outputs.version }}"

          # Save to file (multi-line output)
          echo "$CHANGELOG" > changelog.md
          echo "changelog_file=changelog.md" >> $GITHUB_OUTPUT

      - name: Upload changelog
        if: steps.version.outputs.should_release == 'true' || inputs.force_release
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  build-artifacts:
    name: Build (${{ matrix.runtime }})
    needs: calculate-version
    if: needs.calculate-version.outputs.should_release == 'true' || inputs.force_release
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ needs.calculate-version.outputs.version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runtime: win-x64
            os: windows-latest
            artifact_ext: .zip
          - runtime: linux-x64
            os: ubuntu-latest
            artifact_ext: .tar.gz
          - runtime: linux-arm64
            os: ubuntu-latest
            artifact_ext: .tar.gz
          - runtime: osx-x64
            os: macos-latest
            artifact_ext: .tar.gz
          - runtime: osx-arm64
            os: macos-latest
            artifact_ext: .tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y vlc libvlc-dev fonts-dejavu-core

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Restore
        run: dotnet restore src/LCDPossible.sln

      - name: Build
        run: dotnet build src/LCDPossible.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test src/LCDPossible.sln --configuration Release --no-build --verbosity normal

      - name: Publish
        shell: bash
        run: |
          dotnet publish src/LCDPossible/LCDPossible.csproj \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ env.VERSION }} \
            --output ./publish

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}.zip

      - name: Create archive (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          tar -czvf ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}.tar.gz -C ./publish .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lcdpossible-${{ matrix.runtime }}
          path: ./lcdpossible-${{ env.VERSION }}-${{ matrix.runtime }}${{ matrix.artifact_ext }}

  create-release:
    name: Create Release
    needs: [calculate-version, build-artifacts]
    if: needs.calculate-version.outputs.should_release == 'true' || inputs.force_release
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.calculate-version.outputs.version }}

    steps:
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: lcdpossible-*

      - name: Display artifacts
        run: ls -R ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: LCDPossible v${{ env.VERSION }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            ./artifacts/lcdpossible-win-x64/*
            ./artifacts/lcdpossible-linux-x64/*
            ./artifacts/lcdpossible-linux-arm64/*
            ./artifacts/lcdpossible-osx-x64/*
            ./artifacts/lcdpossible-osx-arm64/*
